{"version":3,"sources":["../src/index.ts","../src/prompt.ts","../src/state.ts"],"sourcesContent":["// Copyright © Aptos\n// SPDX-License-Identifier: Apache-2.0\n\nimport {\n  ConnectRequest,\n  ConnectResponse,\n  DisconnectRequest,\n  DisconnectResponse,\n  GetConnectedAccountsRequest,\n  GetConnectedAccountsResponse,\n  IsConnectedRequest,\n  IsConnectedResponse,\n  SerializedWalletRequest,\n  SignAndSubmitTransactionRequest,\n  SignMessageRequest,\n  SignTransactionRequest,\n  urlEncodeWalletRequest,\n} from '@aptos-connect/wallet-api';\nimport { openPrompt, waitForPromptResponse } from './prompt';\nimport { addConnectedAccount, getConnectedAccounts, removeConnectedAccount } from './state';\n\nexport class WebWalletTransport {\n  constructor(private readonly baseUrl: string) {\n    this.baseUrl = baseUrl;\n  }\n\n  async sendPromptRequest(request: SerializedWalletRequest) {\n    const url = new URL(`${this.baseUrl}/prompt/`);\n    url.searchParams.set('request', urlEncodeWalletRequest(request));\n    const prompt = openPrompt(url);\n    return waitForPromptResponse(this.baseUrl, prompt);\n  }\n\n  async sendRequest(request: SerializedWalletRequest) {\n    switch (request.name) {\n      case IsConnectedRequest.name: {\n        const connectedAccounts = getConnectedAccounts();\n        return IsConnectedResponse.serialize(connectedAccounts.length > 0);\n      }\n      case GetConnectedAccountsRequest.name: {\n        const connectedAccounts = getConnectedAccounts();\n        return GetConnectedAccountsResponse.serialize(connectedAccounts);\n      }\n      case ConnectRequest.name: {\n        const serializedResponse = await this.sendPromptRequest(request);\n        const response = ConnectResponse.deserialize(serializedResponse);\n        if (response.args.status === 'approved') {\n          const { account, pairing } = response.args.args;\n          if (pairing === undefined) {\n            addConnectedAccount(account);\n          }\n        }\n        return serializedResponse;\n      }\n      case DisconnectRequest.name: {\n        const [activeAccount] = getConnectedAccounts();\n        if (activeAccount) {\n          removeConnectedAccount(activeAccount.address);\n        }\n        return DisconnectResponse.serialize({});\n      }\n      case SignMessageRequest.name:\n      case SignTransactionRequest.name:\n      case SignAndSubmitTransactionRequest.name: {\n        return this.sendPromptRequest(request);\n      }\n      default: {\n        throw new Error('Unexpected request');\n      }\n    }\n  }\n}\n","// Copyright © Aptos\n// SPDX-License-Identifier: Apache-2.0\n\nimport {\n  ConnectResponse,\n  isTypedMessage,\n  PromptApprovalResponseMessage,\n  PromptOpenerPingRequestMessage,\n  PromptOpenerPingResponseMessage,\n  PromptUnauthorizedErrorMessage,\n  SerializedWalletResponse,\n} from '@aptos-connect/wallet-api';\n\nconst DEFAULT_PROMPT_SIZE = { height: 695, width: 465 };\nconst PROMPT_POLLER_INTERVAL = 500;\n\nconst dismissalSerializedResponse = ConnectResponse.serialize({ status: 'dismissed' });\n\nexport class PromptUnauthorizedError extends Error {\n  constructor() {\n    super('Unauthorized');\n  }\n}\n\nexport function openPrompt(url: string | URL, size = DEFAULT_PROMPT_SIZE) {\n  const { height, width } = size;\n  const options = {\n    height,\n    left: window.screenLeft + Math.round((window.outerWidth - width) / 2),\n    popup: true,\n    top: window.screenTop + Math.round((window.outerHeight - height) / 2),\n    width,\n  };\n\n  const strOptions = Object.entries(options)\n    .map(([key, value]) => `${key}=${JSON.stringify(value)}`)\n    .reduce((acc, entry) => `${acc}, ${entry}`);\n\n  const href = url instanceof URL ? url.href : url;\n  const promptWindow = window.open(href, undefined, strOptions);\n  if (promptWindow === null) {\n    throw new Error(\"Couldn't open prompt\");\n  }\n\n  return promptWindow;\n}\n\nexport async function waitForPromptResponse(baseUrl: string, promptWindow: Window) {\n  return new Promise<SerializedWalletResponse>((resolve, reject) => {\n    const listeners = {\n      onMessage: (message: MessageEvent) => {\n        // Ignore messages from untrusted sources\n        if (message.source !== promptWindow || message.origin !== baseUrl) {\n          return;\n        }\n        if (isTypedMessage(PromptUnauthorizedErrorMessage, message.data)) {\n          window.removeEventListener('message', listeners.onMessage);\n          clearTimeout(listeners.promptPollerId);\n          reject(new PromptUnauthorizedError());\n          return;\n        }\n        if (isTypedMessage(PromptOpenerPingRequestMessage, message.data)) {\n          promptWindow.postMessage(new PromptOpenerPingResponseMessage(), baseUrl);\n          return;\n        }\n        if (isTypedMessage(PromptApprovalResponseMessage, message.data)) {\n          window.removeEventListener('message', listeners.onMessage);\n          clearTimeout(listeners.promptPollerId);\n          resolve(message.data.serializedValue);\n        }\n      },\n      promptPollerId: setInterval(() => {\n        if (promptWindow.closed) {\n          window.removeEventListener('message', listeners.onMessage);\n          clearTimeout(listeners.promptPollerId);\n          resolve(dismissalSerializedResponse);\n        }\n      }, PROMPT_POLLER_INTERVAL),\n    };\n\n    window.addEventListener('message', listeners.onMessage);\n  });\n}\n","// Copyright © Aptos\n// SPDX-License-Identifier: Apache-2.0\n\nimport {\n  AccountInfo,\n  base64ToBytes,\n  bytesToBase64,\n  deserializeAccountInfo,\n  serializeAccountInfo,\n} from '@aptos-connect/wallet-api';\nimport { AccountAddress, Deserializer, Serializer } from '@aptos-labs/ts-sdk';\n\nconst localDappStateKey = '@aptos-connect/dapp-local-state';\n\n/**\n * Local dapp state loosely synced with the web wallet's state.\n * Due to browser restrictions (storage partitioning), it's no longer possible\n * to access the web wallet's state.\n */\ninterface DappLocalState {\n  connectedAccounts: AccountInfo[];\n}\n\nfunction serializeLocalDappState(state: DappLocalState): Uint8Array {\n  const serializer = new Serializer();\n  serializer.serializeU32AsUleb128(state.connectedAccounts.length);\n  for (const account of state.connectedAccounts) {\n    serializeAccountInfo(serializer, account);\n  }\n  return serializer.toUint8Array();\n}\n\nfunction deserializeLocalDappState(serializedValue: Uint8Array): DappLocalState {\n  const deserializer = new Deserializer(serializedValue);\n  const connectedAccountsLength = deserializer.deserializeUleb128AsU32();\n  const connectedAccounts: AccountInfo[] = [];\n  for (let i = 0; i < connectedAccountsLength; i += 1) {\n    connectedAccounts.push(deserializeAccountInfo(deserializer));\n  }\n  return { connectedAccounts };\n}\n\nfunction getState(): DappLocalState {\n  const encodedValue = window.localStorage.getItem(localDappStateKey);\n  return encodedValue ? deserializeLocalDappState(base64ToBytes(encodedValue)) : { connectedAccounts: [] };\n}\n\nfunction setState(state: DappLocalState) {\n  const serializedValue = serializeLocalDappState(state);\n  const encodedValue = bytesToBase64(serializedValue);\n  window.localStorage.setItem(localDappStateKey, encodedValue);\n}\n\nexport function getConnectedAccounts() {\n  const state = getState();\n  return state.connectedAccounts;\n}\n\nexport function addConnectedAccount(account: AccountInfo) {\n  const { connectedAccounts, ...state } = getState();\n  connectedAccounts.push(account);\n  setState({ ...state, connectedAccounts });\n}\n\nexport function removeConnectedAccount(address: AccountAddress) {\n  const { connectedAccounts, ...state } = getState();\n  const index = connectedAccounts.findIndex((a) => a.address.equals(address));\n  if (index >= 0) {\n    connectedAccounts.splice(index, 1);\n  }\n  setState({ ...state, connectedAccounts });\n}\n"],"mappings":"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","names":["ConnectResponse","ConnectResponse"]}